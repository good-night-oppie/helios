# Helios设计&进度总览（9.5.2025）

## 1) 设计目标与架构

**定位**

Helios 是用户态的状态引擎，提供可追溯的工作集快照与还原，面向「AI/CI 自动化 + 可复现构建」。

**核心组件**

- **VST（Virtual State Tree）**：虚拟工作集；维护 `path → object-hash` 的映射。
- **L1 Cache（内存/本地快速缓存）**：对象级缓存，统计 `Hits/Misses/Items`。
- **L2 Object Store（持久对象库）**：当前实现为 RocksDB（通过 `gorocksdb/CGO`）；后续方向改为 **Pebble**（纯 Go，无 CGO）。
- **Snapshot**：基于 BLAKE3 的对象化根哈希（`blake3:…`），描述一次提交的全局状态。

**数据流（常用路径）**

- `commit(work)`：对工作集对象化 → 写入 **L2** → 产出 `snapshot_id`。
- `restore(id)`：根据 `id` 重建 `path → hash` 映射（可 **eager** 物化或 **lazy** 按需）。
- `materialize(id, out, selectors)`：把选择的文件恢复到磁盘。
- `read(path)`（引擎内部调用）：**先 `L1.Get` 统计到 miss；再 `L2.Get` 命中后 `L1.Put` 提升；二读命中 L1**。
- `stats`：导出命中/未命中/对象个数/延迟等指标。

**CLI**

`commit / restore / diff / materialize / stats`（`restore`、`materialize` 支持选择器；`stats` 查看快照/引擎指标）。

**存储布局**

统一使用 **store root**：`$WORK/.helios`（CI 中通过 env/flag/link 三重桥接，确保 `commit` 与 `materialize` 同库）。

**约束**

- 全用户态，无特权（不依赖 overlayfs / cap_sys_admin）。
- 快照与对象存储可移植；L2 后端抽象（RocksDB ⇢ Pebble）。

---

## 2) 当前实现 & CI

**Engine（引擎本体）**

- VST：对象化、选择器、差异、快照ID；`L1/L2` 接口抽象。
- L1：统计、容量/驱逐、并发安全（在修整中）。
- L2（当前）：RocksDB（后续切换 Pebble）。
- 测试：CLI 层、VST 选择器/一致性、L1/L2 行为、Smoke/Integration 覆盖。

**CI 分层**

- **Engine CI（新接入）**：`go vet / go test / build`；验证 **引擎契约**（诸如 L1 miss→提升→二读 hit）。
- **Thunder Helios CI（已绿）**：容器内从子模块编译 Helios → `commit → materialize` → 执行 demo 的 `.helios-ci/run_tests.sh`。用于 **端到端集成** 验证。

---

## 3) 当前状态（PR & 问题闭环）

- **#5（Engine CI 修复）**：修正 engine-ci.yml 的 YAML/apt 稳定性，确保 GH 托管 runner 上能稳定跑。
    
    **状态**：待在 PR 页面点击 **Squash and merge**（可直接合并；仓库未启用保护规则）。
    
- **#6（ReadFile 路由修复）**：将读取路径改为 **`L1.Get → L2.Get → L1.Put`**，不再绕过 L1 的 miss 统计；配套用例 `TestRestore_PromotesFromL2ToL1` 验证「首读 Miss+Items↑、次读 Hit」。
    
    **状态**：待 CI 绿（需先合并 #5，再 rebase、重跑）。
    
- **#7（L1 统计并发安全/去冗余）**：不改变行为的内部修正。
    
    **状态**：待 CI 绿（同样依赖 #5 的工作流修复）。
    

> 说明：之前 Thunder 的 CI 能绿，是因为只测「能跑通」，不包含 L1 统计用例；现在 Engine CI 加入该用例后，才暴露出 ReadFile 绕过 L1.Get 的问题（#6 解决）。
> 

---

## 4) Release 计划（RC 闸门）

**发版闸门（双层）**

1. **Engine CI 绿**（合并 #5；#6/#7 rebase 到最新 `master` 后重跑通过）。
2. 在 Engine 仓库 **打 RC tag**（如 `helios-v0.1.0-rc2`）。
3. 在 Thunder 仓库 **更新子模块指针**到该 tag，触发 Thunder Helios CI（应保持绿）。
4. 输出 Release Note + 决策包（Decision Package）后，进入 Task 14。

**立即执行的步骤**

- 在 **PR #5** 页面点击 **Squash and merge**。
- 本地将 **#6 / #7** 分支 `git rebase origin/master`，推送后用 GH CLI/网页 **重跑 Engine CI**。
- Checks 绿后合并 **#6**（功能性修复）；按需合并 **#7**（内部修正，可同 RC 或下一增量）。
- 打 RC tag（Engine），在 Thunder bump 子模块，Thunder CI 绿 → 宣布 RC。

---

## 5) 后续事项（与同事约定一致）

**存储后端切换**

- **从 RocksDB（C++/CGO）迁移到 Pebble（纯 Go）**：
    - 移除 CI 中的 RocksDB 安装；
    - 修改 L2 实现与接口适配；
    - 回归/性能对比（首读时延、批量物化、并发晋升）；
    - 风险降低：**无 CGO 边界**，Go 服务集成更稳。

**流程与守护**

- Engine 仓库增加 **CODEOWNERS**：`/pkg/helios/vst/* /l1cache/* /objstore/*` 必须由存储 Owner 审核（你同事）。
- Branch 保护：`master` 勾选「Require PR」+「Require review from Code owners」+「Engine CI 必需检查」。
    
    -（可选）为 `restore` 的 **lazy/eager** 行为加配置门控，按需灰度。
    

**测试与指标**

- 增加「L1 关闭/容量=0」「L2 miss」用例；并发下 `Put` 幂等性用例；`go test -race` 覆盖；
- 指标：`first_read_from_l2_total / lazy_restore_promotions` 等，方便观测迁移效果。

---

## 6) 风险与缓解

- **CI 环境不稳定**：已在 Engine CI 中固定镜像源并加重试；Thunder CI 采用容器，依赖可复现。
- **行为语义变更**（如 `restore` lazy）：作为独立 PR 引入、默认关闭（配置门控），有回滚路径。
- **CGO 集成风险**：转 Pebble 后消失；在过渡期 CI 仅在容器内安装 RocksDB，**不污染宿主**。

---

## 7) 今日待办清单

- [ ]  PR **#5** 页面点击 **Squash and merge**
- [ ]  `fix/vst-readfile-l1-route`（#6）rebase 到最新 master，重跑 Engine CI
- [ ]  `fix/l1cache-stats-safety`（#7）rebase 到最新 master，重跑 Engine CI
- [ ]  两个 PR Checks 绿后合并（先 #6，后 #7 可同批或下批）
- [ ]  **Engine** 打 RC tag（如 `helios-v0.1.0-rc2`），发布 Release
- [ ]  **Thunder** bump 子模块指针到该 RC，跑 Thunder Helios CI（期望绿）

---

> 备注：CI 里安装 RocksDB 仅为当前 L2 构建需要；切到 Pebble 后将移除这一步。合并权限已对齐：涉及 vst/l1cache/objstore 的改动必须由存储 Owner PR/Review。
>